<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROCKET2 Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151a3a;
            --bg-tertiary: #1e2451;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #2e3454;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .token-balance {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .wallet-button {
            padding: 0.5rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .wallet-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .wallet-button.connected {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 0.5rem 1.5rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .nav-tab.active {
            background: var(--bg-tertiary);
            color: var(--accent);
            border-color: var(--border);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calls Table */
        .table-container {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .ticker-cell {
            font-family: monospace;
            font-weight: 600;
            color: var(--accent);
        }

        .group-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 9999px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .roi-positive {
            color: var(--success);
            font-weight: 600;
        }

        .roi-negative {
            color: var(--danger);
            font-weight: 600;
        }

        .network-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .network-eth {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .network-sol {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 0 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
            min-height: 400px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .chart-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .chart-container canvas {
            max-height: 400px;
        }

        /* Info bubble styles */
        .info-bubble {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .info-bubble:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .info-bubble.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .info-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-bottom: 1rem;
        }

        .info-section.expanded {
            max-height: 400px;
        }

        .info-content {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-content h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .info-content p {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .info-content ul {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .info-content li {
            margin-bottom: 0.25rem;
        }

        .tip {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        /* Full width chart */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Token search styles */
        .token-lookup-container {
            padding: 1rem;
        }

        .token-search-input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .token-search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .token-results {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .token-result-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .token-result-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .token-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .token-result-symbol {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success);
        }

        .token-result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .token-stat {
            text-align: center;
        }

        .token-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .token-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Token Gate */
        .token-gate-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.95);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 10;
        }

        .token-gate-content {
            text-align: center;
            padding: 2rem;
        }

        .lock-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }

        .token-gate-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .token-gate-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .token-gate-button {
            padding: 0.75rem 2rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .token-gate-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>ROCKET2 Dashboard</h1>
        <div class="wallet-section">
            <div class="token-balance" id="tokenBalance" style="display: none;">
                <span id="balanceAmount">0</span> ROCKET2
            </div>
            <button class="wallet-button" id="walletButton" onclick="handleWalletConnection()">
                Connect Wallet
            </button>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('calls')">Calls</button>
        <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Calls Tab -->
        <div id="callsTab" class="tab-content active">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Total Calls</div>
                    <div class="stat-value" id="totalCalls">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Groups</div>
                    <div class="stat-value" id="activeGroups">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg ROI</div>
                    <div class="stat-value" id="avgROI">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">24h Calls</div>
                    <div class="stat-value" id="dailyCalls">-</div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Recent Crypto Calls</h2>
                </div>
                <div class="table-wrapper">
                    <table id="callsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Token</th>
                                <th>Group</th>
                                <th>Network</th>
                                <th>Buy Price</th>
                                <th>Top Price</th>
                                <th>ROI</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="callsTableBody">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="loading-spinner"></div>
                                    Loading calls...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content">
            <div class="analytics-grid">
                <!-- Network Performance -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Network Performance
                                <span class="info-bubble" onclick="toggleInfo('network-performance')">?</span>
                            </h3>
                            <p class="chart-subtitle">ETH vs SOL comparison</p>
                        </div>
                    </div>
                    <div class="info-section" id="network-performance-info">
                        <div class="info-content">
                            <h4>üìä Network Analysis</h4>
                            <p>Compare performance between Ethereum and Solana networks:</p>
                            <ul>
                                <li>Blue bars show average ROI per network</li>
                                <li>Purple bars show win rate percentage</li>
                                <li>Higher values indicate better performance</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Focus on the network with higher win rates for more consistent profits
                            </div>
                        </div>
                    </div>
                    <canvas id="networkPerformanceChart"></canvas>
                </div>

                <!-- Hourly Heatmap (Full Width) -->
                <div class="chart-container full-width">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Best Trading Times
                                <span class="info-bubble" onclick="toggleInfo('hourly-heatmap')">?</span>
                            </h3>
                            <p class="chart-subtitle">24-hour ROI heatmap by day</p>
                        </div>
                    </div>
                    <div class="info-section" id="hourly-heatmap-info">
                        <div class="info-content">
                            <h4>‚è∞ Timing Analysis</h4>
                            <p>Discover the most profitable hours to trade:</p>
                            <ul>
                                <li><strong>Green cells:</strong> High average ROI times</li>
                                <li><strong>Red cells:</strong> Low/negative ROI times</li>
                                <li>Times shown in UTC - convert to your timezone</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Set alerts for consistently green time slots
                            </div>
                        </div>
                    </div>
                    <div id="hourly-heatmap-container">
                        <div class="loading">Loading heatmap...</div>
                    </div>
                </div>

                <!-- 10X+ Tokens Scatter Plot (Full Width) -->
                <div class="chart-container full-width">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                10X+ Token Timeline
                                <span class="info-bubble" onclick="toggleInfo('moonshot-timeline')">?</span>
                            </h3>
                            <p class="chart-subtitle">All tokens that reached 10X+ since November</p>
                        </div>
                    </div>
                    <div class="info-section" id="moonshot-timeline-info">
                        <div class="info-content">
                            <h4>üéØ Historical Moonshots</h4>
                            <p>Track when tokens hit their peak multipliers:</p>
                            <ul>
                                <li><strong>X-axis:</strong> Date when peak was reached</li>
                                <li><strong>Y-axis:</strong> Maximum multiplier achieved</li>
                                <li><strong>Dot size:</strong> Time to reach peak (bigger = slower)</li>
                                <li><strong>Color:</strong> Network (Blue=ETH, Green=SOL)</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Notice clustering patterns - moonshots often come in waves!
                            </div>
                        </div>
                    </div>
                    <canvas id="moonshotTimelineChart" style="height: 400px;"></canvas>
                </div>

                <!-- Top Groups Table -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Top Performing Groups
                                <span class="info-bubble" onclick="toggleInfo('top-groups')">?</span>
                            </h3>
                            <p class="chart-subtitle">Ranked by success score</p>
                        </div>
                    </div>
                    <div class="info-section" id="top-groups-info">
                        <div class="info-content">
                            <h4>üèÜ Scoring System</h4>
                            <p>Groups ranked by: <strong>Win Rate √ó Avg ROI √ó ‚àöCall Count</strong></p>
                            <ul>
                                <li>Balances profitability with reliability</li>
                                <li>Minimum 5 calls required to qualify</li>
                                <li>Higher scores = more consistent performance</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Follow top 3 groups closely - they consistently deliver results
                            </div>
                        </div>
                    </div>
                    <div id="topGroupsTable" style="overflow-x: auto; max-height: 400px;"></div>
                </div>

                <!-- Recent Moonshots -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Recent Moonshots
                                <span class="info-bubble" onclick="toggleInfo('moonshots')">?</span>
                            </h3>
                            <p class="chart-subtitle">Latest 10x+ calls</p>
                        </div>
                    </div>
                    <div class="info-section" id="moonshots-info">
                        <div class="info-content">
                            <h4>üöÄ Learning from Winners</h4>
                            <p>Study these 10x+ returns to spot patterns:</p>
                            <ul>
                                <li>Note how quickly they reached peak</li>
                                <li>Track which groups find moonshots</li>
                                <li>Identify common networks and timing</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Most moonshots peak within minutes - speed is crucial!
                            </div>
                        </div>
                    </div>
                    <div id="recentMoonshotsContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading">Loading moonshots...</div>
                    </div>
                </div>

                <!-- Quick Token Lookup -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                üîç Quick Token Lookup
                                <span class="info-bubble" onclick="toggleInfo('token-lookup')">?</span>
                            </h3>
                            <p class="chart-subtitle">Instant token stats</p>
                        </div>
                    </div>
                    <div class="info-section" id="token-lookup-info">
                        <div class="info-content">
                            <h4>üîç Token Search</h4>
                            <p>Quick lookup any token by symbol or contract:</p>
                            <ul>
                                <li>Search by ticker (e.g., PEPE)</li>
                                <li>Search by contract address</li>
                                <li>View all calls for that token</li>
                                <li>See average ROI and success rate</li>
                            </ul>
                            <div class="tip">
                                üí° <strong>Trading Tip:</strong> Check if a token has been called before to avoid re-pumps
                            </div>
                        </div>
                    </div>
                    <div class="token-lookup-container">
                        <input type="text" id="token-search" class="token-search-input" placeholder="Enter token symbol or contract..." onkeyup="handleTokenSearch(event)">
                        <div id="token-results" class="token-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let tokenBalance = 0;
        let currentPage = 1;
        const itemsPerPage = 50;
        const tokenAddress = '0x2059e89d75f3fc0d2e256d08ba49db7f5a7e5681';
        const requiredTokens = 1000000; // 1M tokens
        let isConnecting = false; // Prevent multiple connection attempts

        // Initialize
        window.addEventListener('load', () => {
            console.log('Window loaded');
            
            // Give ethers a moment to fully load
            setTimeout(() => {
                console.log('Ethers available:', typeof ethers !== 'undefined');
                
                if (typeof ethers === 'undefined') {
                    console.error('Ethers.js failed to load!');
                    // Don't show alert immediately, it might still be loading
                    setTimeout(() => {
                        if (typeof ethers === 'undefined') {
                            alert('Failed to load Web3 library. Please refresh the page.');
                        }
                    }, 2000);
                    return;
                }
                
                loadStats();
                loadCalls();
                checkWalletConnection();
            }, 500);
        });

        // Wallet Connection
        async function checkWalletConnection() {
            // Don't auto-connect, just check if wallet is available
            if (typeof window.ethereum !== 'undefined') {
                console.log('Wallet detected, ready for manual connection');
            }
        }

        async function handleWalletConnection() {
            console.log('handleWalletConnection called');
            console.log('Current userAddress:', userAddress);
            
            if (userAddress) {
                // Disconnect
                userAddress = null;
                tokenBalance = 0;
                updateWalletUI();
            } else {
                await connectWallet();
            }
        }

        async function connectWallet() {
            console.log('connectWallet called');
            
            if (isConnecting) {
                console.log('Already connecting, skipping...');
                return;
            }
            
            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                alert('Web3 library not loaded. Please refresh the page.');
                return;
            }
            
            // Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to use this feature');
                return;
            }

            isConnecting = true;
            try {
                // Request account access
                console.log('Requesting accounts...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                console.log('Connected to:', userAddress);

                // Create provider and signer (ethers v6)
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                console.log('Provider and signer created');

                // Check network
                const network = await provider.getNetwork();
                console.log('Network:', network);
                
                if (network.chainId !== 8453n) { // Base mainnet (BigInt in v6)
                    console.log('Switching to Base network...');
                    await switchToBase();
                }

                // Get token balance
                console.log('Getting token balance...');
                await updateTokenBalance();
                updateWalletUI();

            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet: ' + error.message);
            } finally {
                isConnecting = false;
            }
        }

        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2105' }], // Base chain ID
                });
            } catch (error) {
                // Chain not added, add it
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x2105',
                            chainName: 'Base',
                            nativeCurrency: {
                                name: 'Ethereum',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: ['https://mainnet.base.org'],
                            blockExplorerUrls: ['https://basescan.org']
                        }]
                    });
                } else {
                    throw error;
                }
            }
        }

        async function updateTokenBalance() {
            if (!userAddress || !provider) return;

            try {
                console.log('Fetching balance for token:', tokenAddress);
                // ERC20 ABI for balanceOf and decimals
                const abi = [
                    'function balanceOf(address owner) view returns (uint256)',
                    'function decimals() view returns (uint8)'
                ];
                const contract = new ethers.Contract(tokenAddress, abi, provider);
                
                // Get decimals first
                const decimals = await contract.decimals();
                console.log('Token decimals:', decimals);
                
                const balance = await contract.balanceOf(userAddress);
                console.log('Raw balance:', balance.toString());
                
                // Format with correct decimals (ethers v6 syntax)
                tokenBalance = parseFloat(ethers.formatUnits(balance, decimals));
                console.log('Formatted balance:', tokenBalance);
                
            } catch (error) {
                console.error('Error fetching token balance:', error);
                tokenBalance = 0;
            }
        }

        function updateWalletUI() {
            const button = document.getElementById('walletButton');
            const balanceDiv = document.getElementById('tokenBalance');
            const balanceAmount = document.getElementById('balanceAmount');

            if (userAddress) {
                button.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                button.classList.add('connected');
                balanceDiv.style.display = 'block';
                balanceAmount.textContent = tokenBalance.toLocaleString();
            } else {
                button.textContent = 'Connect Wallet';
                button.classList.remove('connected');
                balanceDiv.style.display = 'none';
            }
        }


        // Tab Switching
        function switchTab(tab) {
            // Update nav
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            // Load analytics if needed
            if (tab === 'analytics') {
                loadAnalytics();
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const response = await fetch('http://localhost:5001/api/stats');
                const stats = await response.json();

                document.getElementById('totalCalls').textContent = stats.total_calls.toLocaleString();
                document.getElementById('activeGroups').textContent = stats.unique_groups;
                document.getElementById('avgROI').textContent = (stats.avg_roi || 0).toFixed(2) + 'x';
                document.getElementById('dailyCalls').textContent = stats.calls_24h || '0';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Calls
        async function loadCalls() {
            try {
                const response = await fetch(`http://localhost:5001/api/calls?page=${currentPage}&per_page=${itemsPerPage}`);
                const data = await response.json();

                renderCallsTable(data.data || data.calls || []);
                renderPagination(data.pagination?.total || data.total, data.pagination?.page || data.page, data.pagination?.total_pages || data.total_pages);
            } catch (error) {
                console.error('Error loading calls:', error);
                document.getElementById('callsTableBody').innerHTML = '<tr><td colspan="8" class="loading">Error loading calls</td></tr>';
            }
        }

        function renderCallsTable(calls) {
            const tbody = document.getElementById('callsTableBody');
            
            if (!calls || calls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No calls found</td></tr>';
                return;
            }

            tbody.innerHTML = calls.map(call => {
                // Check if timestamp is already in milliseconds or seconds
                const timestamp = call.buy_timestamp > 9999999999 ? call.buy_timestamp / 1000 : call.buy_timestamp;
                const date = new Date(timestamp * 1000);
                const timeStr = date.toLocaleString();
                const roi = call.roi || 0;
                const roiClass = roi >= 1 ? 'roi-positive' : 'roi-negative';
                const network = detectNetwork(call.contract_address);
                const networkClass = network === 'SOL' ? 'network-sol' : 'network-eth';

                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td class="ticker-cell">${call.symbol || call.ticker || 'Unknown'}</td>
                        <td><span class="group-badge">${call.group_name || 'N/A'}</span></td>
                        <td><span class="network-badge ${networkClass}">${network}</span></td>
                        <td>$${formatPrice(call.buy_price)}</td>
                        <td>$${formatPrice(call.top_price)}</td>
                        <td class="${roiClass}">${roi.toFixed(2)}x</td>
                        <td>${getStatus(call)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination(total, page, pages) {
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = `
                <button onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                <span class="page-info">Page ${page} of ${pages} (${total} total)</span>
                <button onclick="changePage(${page + 1})" ${page === pages ? 'disabled' : ''}>Next</button>
            `;
        }

        function changePage(page) {
            currentPage = page;
            loadCalls();
        }

        // Analytics
        async function loadAnalytics() {
            updateNetworkPerformance();
            updateHourlyHeatmap();
            updateMoonshotTimeline();
            updateTopGroups();
            updateRecentMoonshots();
        }

        // Info Toggle Function
        function toggleInfo(chartId) {
            const infoSection = document.getElementById(`${chartId}-info`);
            const infoBubble = event.target;
            
            if (infoSection) {
                infoSection.classList.toggle('expanded');
                infoBubble.classList.toggle('active');
            }
        }


        async function updateNetworkPerformance() {
            try {
                const response = await fetch('http://localhost:5001/api/analysis/network-performance');
                const data = await response.json();
                
                const ctx = document.getElementById('networkPerformanceChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.networks.map(n => n.name),
                        datasets: [
                            {
                                label: 'Average ROI',
                                data: data.networks.map(n => n.avg_roi),
                                backgroundColor: '#3b82f6',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Win Rate %',
                                data: data.networks.map(n => n.win_rate),
                                backgroundColor: '#8b5cf6',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Average ROI',
                                    color: '#a1a1aa'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: { color: '#a1a1aa' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Win Rate %',
                                    color: '#a1a1aa'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: { color: '#a1a1aa' }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: { color: '#a1a1aa' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating network performance:', error);
            }
        }

        async function updateHourlyHeatmap() {
            try {
                const response = await fetch('http://localhost:5001/api/analysis/hourly-heatmap');
                const data = await response.json();
                
                // Create heatmap visualization
                const container = document.getElementById('hourly-heatmap-container');
                container.innerHTML = '<div id="heatmap-grid" style="display: grid; grid-template-columns: repeat(25, 1fr); gap: 2px; margin-top: 2rem;"></div>';
                
                const grid = document.getElementById('heatmap-grid');
                
                // Add headers
                grid.innerHTML = '<div></div>'; // Empty corner
                for (let hour = 0; hour < 24; hour++) {
                    const hourDiv = document.createElement('div');
                    hourDiv.style.cssText = 'text-align: center; font-size: 0.8rem; color: #666;';
                    hourDiv.textContent = hour;
                    grid.appendChild(hourDiv);
                }
                
                // Add rows
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                days.forEach((day, dayIdx) => {
                    const dayLabel = document.createElement('div');
                    dayLabel.style.cssText = 'text-align: right; padding-right: 0.5rem; font-size: 0.8rem; color: #666;';
                    dayLabel.textContent = day;
                    grid.appendChild(dayLabel);
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const cell = document.createElement('div');
                        const value = data.heatmap[dayIdx]?.[hour] || 0;
                        const intensity = Math.min(value / 5, 1); // More sensitive normalization
                        
                        // Brighter color gradient from dark blue to bright green
                        let bgColor;
                        if (value <= 0.5) {
                            bgColor = `rgba(59, 130, 246, ${0.3})`; // Blue for low values
                        } else if (value <= 1) {
                            bgColor = `rgba(59, 130, 246, ${0.6})`; // Brighter blue
                        } else if (value <= 2) {
                            bgColor = `rgba(34, 197, 94, ${0.7})`; // Green
                        } else if (value <= 5) {
                            bgColor = `rgba(34, 197, 94, ${0.9})`; // Bright green
                        } else {
                            bgColor = `rgba(74, 222, 128, 1)`; // Very bright green for high values
                        }
                        
                        cell.style.cssText = `
                            background: ${bgColor};
                            border-radius: 4px;
                            aspect-ratio: 1;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            position: relative;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                        `;
                        
                        cell.title = `${day} ${hour}:00 - Avg ROI: ${value.toFixed(2)}x`;
                        cell.onmouseover = () => {
                            cell.style.transform = 'scale(1.2)';
                            cell.style.zIndex = '10';
                        };
                        cell.onmouseout = () => {
                            cell.style.transform = 'scale(1)';
                            cell.style.zIndex = '1';
                        };
                        
                        grid.appendChild(cell);
                    }
                });
            } catch (error) {
                console.error('Error updating hourly heatmap:', error);
            }
        }

        async function updateMoonshotTimeline() {
            try {
                const response = await fetch('http://localhost:5001/api/analysis/moonshot-timeline');
                const data = await response.json();
                
                const ctx = document.getElementById('moonshotTimelineChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.moonshotTimelineChart) {
                    window.moonshotTimelineChart.destroy();
                }
                
                // Prepare data for scatter plot
                const scatterData = data.moonshots.map(token => ({
                    x: new Date(token.top_timestamp * 1000),
                    y: token.roi,
                    tokenInfo: {
                        symbol: token.symbol,
                        group: token.group_name,
                        network: detectNetwork(token.contract_address),
                        timeToReach: token.time_to_reach_minutes
                    }
                }));
                
                // Separate by network
                const ethData = scatterData.filter(d => d.tokenInfo.network === 'ETH');
                const solData = scatterData.filter(d => d.tokenInfo.network === 'SOL');
                
                window.moonshotTimelineChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'ETH Tokens',
                            data: ethData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            pointRadius: ethData.map(d => Math.min(d.tokenInfo.timeToReach / 10 + 4, 12)),
                            pointHoverRadius: ethData.map(d => Math.min(d.tokenInfo.timeToReach / 10 + 6, 14))
                        }, {
                            label: 'SOL Tokens',
                            data: solData,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            pointRadius: solData.map(d => Math.min(d.tokenInfo.timeToReach / 10 + 4, 12)),
                            pointHoverRadius: solData.map(d => Math.min(d.tokenInfo.timeToReach / 10 + 6, 14))
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'var(--text-primary)',
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const token = context.raw.tokenInfo;
                                        return [
                                            `${token.symbol}: ${context.parsed.y.toFixed(1)}x`,
                                            `Group: ${token.group}`,
                                            `Time to peak: ${token.timeToReach} mins`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM dd'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Date Reached Peak',
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'var(--text-secondary)'
                                }
                            },
                            y: {
                                type: 'logarithmic',
                                min: 10,
                                title: {
                                    display: true,
                                    text: 'Peak Multiplier (X)',
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'var(--text-secondary)',
                                    callback: function(value) {
                                        return value + 'x';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating moonshot timeline:', error);
            }
        }

        async function updateTopGroups() {
            try {
                const response = await fetch('http://localhost:5001/api/analysis/top-groups?limit=10');
                const data = await response.json();
                
                const container = document.getElementById('topGroupsTable');
                
                if (data.groups && data.groups.length > 0) {
                    let html = '<table style="width: 100%; color: var(--text-primary);">';
                    html += '<thead><tr>';
                    html += '<th style="text-align: left; padding: 0.5rem;">Group</th>';
                    html += '<th style="text-align: right; padding: 0.5rem;">Score</th>';
                    html += '<th style="text-align: right; padding: 0.5rem;">Avg ROI</th>';
                    html += '<th style="text-align: right; padding: 0.5rem;">Win %</th>';
                    html += '<th style="text-align: right; padding: 0.5rem;">Calls</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.groups.forEach((group, idx) => {
                        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '';
                        html += `<tr style="border-bottom: 1px solid var(--border);">`;
                        html += `<td style="padding: 0.5rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${group.name}">${medal} ${group.name}</td>`;
                        html += `<td style="text-align: right; padding: 0.5rem; color: #8b5cf6;">${group.score.toFixed(0)}</td>`;
                        html += `<td style="text-align: right; padding: 0.5rem; color: ${group.avg_roi > 2 ? 'var(--success)' : 'var(--text-secondary)'};">${group.avg_roi.toFixed(2)}x</td>`;
                        html += `<td style="text-align: right; padding: 0.5rem;">${group.win_rate.toFixed(1)}%</td>`;
                        html += `<td style="text-align: right; padding: 0.5rem;">${group.call_count}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No data available</p>';
                }
            } catch (error) {
                console.error('Error updating top groups:', error);
                container.innerHTML = '<p style="color: var(--danger);">Error loading data</p>';
            }
        }

        async function updateRecentMoonshots() {
            try {
                const response = await fetch('http://localhost:5001/api/analysis/recent-moonshots?limit=10');
                const data = await response.json();
                
                const container = document.getElementById('recentMoonshotsContainer');
                
                if (data.moonshots && data.moonshots.length > 0) {
                    let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    
                    data.moonshots.forEach(call => {
                        const timeAgo = getTimeAgo(new Date(call.timestamp));
                        html += `
                            <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; transition: all 0.3s ease;" 
                                 onmouseover="this.style.borderColor='var(--success)'" 
                                 onmouseout="this.style.borderColor='var(--border)'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--success);">${call.ticker}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${call.group_name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${timeAgo} ‚Ä¢ ${call.network}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${call.roi.toFixed(2)}x</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">in ${call.time_to_peak} min</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No recent moonshots</p>';
                }
            } catch (error) {
                console.error('Error updating recent moonshots:', error);
                container.innerHTML = '<p style="color: var(--danger);">Error loading data</p>';
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Token Search Functions
        let searchTimeout;
        function handleTokenSearch(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('token-results').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(() => searchTokens(query), 300);
        }

        async function searchTokens(query) {
            try {
                const response = await fetch(`http://localhost:5001/api/analysis/token-search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const container = document.getElementById('token-results');
                
                if (data.tokens && data.tokens.length > 0) {
                    container.innerHTML = data.tokens.map(token => `
                        <div class="token-result-item">
                            <div class="token-result-header">
                                <div class="token-result-symbol">${token.symbol}</div>
                                <div style="color: #888;">${token.call_count} calls</div>
                            </div>
                            <div class="token-result-stats">
                                <div class="token-stat">
                                    <div class="token-stat-value">${token.avg_roi.toFixed(2)}x</div>
                                    <div class="token-stat-label">Avg ROI</div>
                                </div>
                                <div class="token-stat">
                                    <div class="token-stat-value">${token.best_roi.toFixed(2)}x</div>
                                    <div class="token-stat-label">Best ROI</div>
                                </div>
                                <div class="token-stat">
                                    <div class="token-stat-value">${token.win_rate.toFixed(0)}%</div>
                                    <div class="token-stat-label">Win Rate</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #888;">No tokens found</div>';
                }
            } catch (error) {
                console.error('Error searching tokens:', error);
            }
        }

        // Utility Functions
        function detectNetwork(address) {
            if (!address) return 'Unknown';
            if (address.length === 44) return 'SOL';
            if (address.startsWith('0x')) return 'ETH';
            return 'Unknown';
        }

        function formatPrice(price) {
            if (!price) return '0.00';
            if (price < 0.01) return price.toExponential(2);
            return price.toFixed(4);
        }

        function getStatus(call) {
            if (call.trade_error) return '‚ùå Error';
            if (call.hidden) return 'üëª Hidden';
            if (call.roi >= 2) return 'üöÄ Success';
            if (call.roi >= 1) return '‚úÖ Profit';
            return 'üìâ Loss';
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    userAddress = null;
                    tokenBalance = 0;
                    updateWalletUI();
                    updateTokenGates();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Chain changed to:', chainId);
                // Only reload if not on Base network
                if (chainId !== '0x2105') {
                    console.log('Not on Base network, reloading...');
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>