<!-- Add this to your krom-analysis-viz.html file -->

<!-- 1. Add ethers.js CDN in the <head> section after Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

<!-- 2. Add wallet UI elements to your header or navigation -->
<div class="wallet-section" style="display: flex; align-items: center; gap: 1rem;">
    <button id="wallet-connect-btn" class="wallet-btn" onclick="handleWalletConnect()">
        Connect Wallet
    </button>
    <span id="wallet-status" class="wallet-status" style="display: none;">
        <span class="wallet-address"></span>
        <span class="wallet-network"></span>
    </span>
</div>

<!-- 3. Add these styles to your existing styles -->
<style>
    .wallet-btn {
        background: var(--accent-purple);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .wallet-btn:hover {
        background: #8030ff;
    }

    .wallet-btn.connected {
        background: var(--accent-green);
    }

    .wallet-status {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .wallet-address {
        font-family: monospace;
        margin-right: 0.5rem;
    }

    .wallet-network {
        padding: 0.25rem 0.5rem;
        background: var(--bg-card);
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .wallet-network.base {
        background: var(--accent-green);
        color: black;
    }
</style>

<!-- 4. Add this JavaScript code to your existing script section -->
<script>
    // Wallet Integration
    let walletManager = null;
    let walletConnected = false;

    // Initialize wallet manager when page loads
    window.addEventListener('load', () => {
        if (typeof ethers !== 'undefined') {
            // Create script element for wallet integration
            const script = document.createElement('script');
            script.src = 'wallet-integration.js';
            script.onload = () => {
                walletManager = new WalletManager();
                
                // Set up event handlers
                walletManager.onAccountsChanged = (account) => {
                    if (account) {
                        updateWalletUI(account);
                    } else {
                        resetWalletUI();
                    }
                };
                
                walletManager.onChainChanged = async (chainId) => {
                    updateNetworkUI(chainId);
                };
            };
            document.head.appendChild(script);
        } else {
            console.error('ethers.js not loaded!');
        }
    });

    async function handleWalletConnect() {
        if (!walletManager) {
            alert('Wallet manager not initialized. Please refresh the page.');
            return;
        }

        if (walletConnected) {
            // Disconnect
            walletManager.disconnect();
            resetWalletUI();
            walletConnected = false;
        } else {
            // Connect
            const result = await walletManager.connect();
            if (result.success) {
                walletConnected = true;
                updateWalletUI(result.account);
                updateNetworkUI(result.chainId);
                
                // Show ETH balance
                console.log(`ETH Balance: ${result.ethBalance} ETH`);
                
                // If not on Base, offer to switch
                if (!result.isBase) {
                    const shouldSwitch = confirm('You are not on Base network. Would you like to switch?');
                    if (shouldSwitch) {
                        const switchResult = await walletManager.switchToBase();
                        if (switchResult.success) {
                            console.log(switchResult.message);
                        } else {
                            console.error(switchResult.error);
                        }
                    }
                }
                
                // Example: Check a specific token balance
                // const tokenResult = await walletManager.getTokenBalance('0x2059e89d75f3fc0d2e256d08ba49db7f5a7e5681');
                // if (tokenResult.success) {
                //     console.log(`Token Balance: ${tokenResult.balance} ${tokenResult.symbol}`);
                // }
            } else {
                alert(`Connection failed: ${result.error}`);
            }
        }
    }

    function updateWalletUI(account) {
        const btn = document.getElementById('wallet-connect-btn');
        const status = document.getElementById('wallet-status');
        const addressSpan = status.querySelector('.wallet-address');
        
        btn.textContent = 'Disconnect';
        btn.classList.add('connected');
        
        // Show shortened address
        addressSpan.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
        status.style.display = 'flex';
    }

    function updateNetworkUI(chainId) {
        const networkSpan = document.querySelector('.wallet-network');
        const isBase = chainId === '0x2105';
        
        networkSpan.textContent = isBase ? 'Base' : `Chain ${parseInt(chainId, 16)}`;
        networkSpan.classList.toggle('base', isBase);
    }

    function resetWalletUI() {
        const btn = document.getElementById('wallet-connect-btn');
        const status = document.getElementById('wallet-status');
        
        btn.textContent = 'Connect Wallet';
        btn.classList.remove('connected');
        status.style.display = 'none';
    }

    // Example function to check token balances from your calls data
    async function checkCallTokenBalances() {
        if (!walletManager || !walletConnected) {
            alert('Please connect your wallet first');
            return;
        }

        // Get unique token addresses from your calls
        const tokenAddresses = [...new Set(callsData.map(call => call.contract_address).filter(addr => addr))];
        
        console.log(`Checking balances for ${tokenAddresses.length} tokens...`);
        const balances = await walletManager.getMultipleTokenBalances(tokenAddresses.slice(0, 10)); // Check first 10
        
        // Display results
        balances.forEach(result => {
            if (result.success && parseFloat(result.balance) > 0) {
                console.log(`${result.symbol}: ${result.balance} (${result.percentageOfSupply}% of supply)`);
            }
        });
    }
</script>