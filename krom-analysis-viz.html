<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KROM Analysis Platform</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-blue: #00b4d8;
            --accent-purple: #9945ff;
            --border-color: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            backdrop-filter: blur(10px);
            background: rgba(26, 26, 26, 0.9);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .nav-tab.active {
            background: var(--accent-blue);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            gap: 1rem;
            padding: 1rem;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
            display: none;
        }

        .sidebar.active {
            display: block;
        }

        /* Split View Container */
        .split-view {
            display: flex;
            flex: 1;
            gap: 1rem;
            overflow: hidden;
        }

        /* Chat Container */
        .chat-container {
            width: 35%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Workspace Container */
        .workspace-container {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--accent-blue);
        }

        .message.ai .message-avatar {
            background: var(--accent-purple);
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .message.user .message-content {
            background: var(--accent-blue);
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 0.75rem 1rem;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            display: flex;
            gap: 1rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .chat-input button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        /* Analysis Panel */
        .analysis-panel {
            padding: 1.5rem;
            display: none;
            overflow-y: auto;
        }

        .analysis-panel.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.positive {
            color: var(--accent-green);
        }

        .stat-value.negative {
            color: var(--accent-red);
        }

        /* Chart Containers */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Table Styles */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--accent-blue);
            font-weight: 600;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }

        tbody tr:hover {
            background: rgba(0, 180, 216, 0.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error {
            color: var(--accent-red);
            padding: 1rem;
            background: rgba(255, 51, 102, 0.1);
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .split-view {
                flex-direction: column;
            }
            
            .chat-container {
                width: 100%;
                height: 50%;
            }
            
            .workspace-container {
                height: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
            }
            
            .message-content {
                max-width: 85%;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>KROM Analysis Platform</h1>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('chat')">🤖 AI Chat</button>
                <button class="nav-tab" onclick="showTab('analysis')">📊 Dashboard</button>
                <button class="nav-tab" onclick="showTab('calls')">📋 All Calls</button>
                <button class="nav-tab" onclick="showTab('admin')">⚙️ Admin</button>
                <button class="nav-tab" onclick="toggleSidebar()">📈 Quick Stats</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar for Quick Stats -->
        <aside class="sidebar" id="sidebar">
            <h3 style="margin-bottom: 1rem;">Quick Stats</h3>
            <div id="quick-stats">
                <div class="loading">Loading stats...</div>
            </div>
        </aside>

        <!-- Split View for Chat Tab -->
        <div class="split-view" id="chat-tab">
            <!-- Chat Container (Left Side) -->
            <div class="chat-container">
                <div class="chat-header">
                    <h3>AI Assistant</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="copyConversation()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 0.75rem; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;">📋 Copy</button>
                        <button onclick="clearChat()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 0.75rem; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;">Clear</button>
                    </div>
                </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message ai">
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <p>👋 Hello! I'm your KROM Analysis AI Assistant. I can help you with:</p>
                        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                            <li>Analyzing KROM call data</li>
                            <li>Finding profitable patterns</li>
                            <li>Tracking group performance</li>
                            <li>Real-time crypto prices</li>
                            <li>Market sentiment analysis</li>
                        </ul>
                        <p style="margin-top: 0.5rem;">Try asking: "Show me the top performing calls this week" or "What's the win rate for each group?"</p>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <div class="message ai">
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button id="suggest-analysis-btn" onclick="suggestAnalysis()" style="flex: 1; padding: 0.5rem; background: linear-gradient(135deg, #9945ff, #00b4d8); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                        💡 Suggest Analysis
                    </button>
                    <button id="surprise-me-btn" onclick="surpriseMe()" style="flex: 1; padding: 0.5rem; background: linear-gradient(135deg, #00ff88, #00b4d8); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                        🎲 Surprise Me
                    </button>
                    <button id="monitor-btn" onclick="toggleMonitoring()" style="flex: 1; padding: 0.5rem; background: linear-gradient(135deg, #ff3366, #ff6b6b); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                        🔍 Start Monitoring
                    </button>
                </div>
                <form id="chat-form" class="input-container">
                    <input type="text" id="user-input" placeholder="Ask me anything about crypto or KROM calls..." required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
        
        <!-- Workspace Container (Right Side) -->
        <div class="workspace-container">
            <div class="workspace-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3>Workspace</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="clearWorkspace()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;">🗑️ Clear</button>
                </div>
            </div>
            <div id="workspace-content" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <!-- Dynamic visualizations will appear here -->
                <div id="workspace-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center;">
                    <div>
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                        <p>Your visualizations will appear here</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Ask the AI to create charts, tables, or run analysis</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Dashboard -->
        <div class="chat-container analysis-panel" id="analysis-tab">
            <!-- Stats Overview -->
            <div class="stats-grid" id="analysis-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Calls</div>
                    <div class="stat-value" id="total-calls">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value positive" id="win-rate">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average ROI</div>
                    <div class="stat-value" id="avg-roi">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max ROI</div>
                    <div class="stat-value positive" id="max-roi">-</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h3 class="chart-title">ROI Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="roi-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Network Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="network-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Performing Groups Table -->
            <div class="table-container">
                <h3 class="chart-title">Top Performing Groups</h3>
                <table id="groups-table">
                    <thead>
                        <tr>
                            <th>Group Name</th>
                            <th>Calls</th>
                            <th>Avg ROI</th>
                            <th>Wins</th>
                            <th>Win Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Daily Performance Chart -->
            <div class="chart-container" style="grid-column: 1 / -1;">
                <h3 class="chart-title">Daily Performance (Last 30 Days)</h3>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Calls Table Container -->
        <div class="analysis-panel" id="calls-tab" style="padding: 1.5rem; display: none; max-width: 95%; margin: 0 auto;">
            <!-- All Calls Table -->
            <div class="table-container" style="grid-column: 1 / -1;">
                <h3 class="chart-title">All KROM Calls</h3>
                
                <!-- Controls -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <label style="color: var(--text-secondary);">Sort by:</label>
                        <select id="sort-select" onchange="loadCallsTable(1)" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 6px;">
                            <option value="call_timestamp-DESC">Date (Newest)</option>
                            <option value="call_timestamp-ASC">Date (Oldest)</option>
                            <option value="roi-DESC">ROI (Highest)</option>
                            <option value="roi-ASC">ROI (Lowest)</option>
                            <option value="profit_percent-DESC">Profit % (Highest)</option>
                            <option value="ticker-ASC">Ticker (A-Z)</option>
                        </select>
                        
                        <label style="color: var(--text-secondary);">Per page:</label>
                        <select id="perpage-select" onchange="loadCallsTable(1)" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 6px;">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    
                    <div id="pagination-info" style="color: var(--text-secondary);">
                        <!-- Pagination info will be inserted here -->
                    </div>
                </div>
                
                <!-- Table -->
                <div style="overflow-x: auto;">
                    <table id="calls-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Network</th>
                                <th>Group</th>
                                <th>Contract</th>
                                <th>Pair Address</th>
                                <th>Buy Price</th>
                                <th>Top Price</th>
                                <th>Current Price</th>
                                <th>ROI</th>
                                <th>Profit %</th>
                                <th>Buy Time</th>
                                <th>Top Time</th>
                                <th>Hidden</th>
                                <th>Error</th>
                                <th>Message ID</th>
                                <th>Status</th>
                                <th>Raw Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="18" style="text-align: center; color: var(--text-secondary);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div id="pagination-controls" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem;">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="chat-container analysis-panel" id="admin-tab" style="padding: 1.5rem; display: none;">
            <h2 style="margin-bottom: 2rem; color: var(--accent-blue);">⚙️ Admin Panel</h2>
            
            <!-- System Prompt Section -->
            <div class="chart-container" style="margin-bottom: 2rem;">
                <h3 class="chart-title">System Prompt</h3>
                <div style="padding: 1rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        This is the main instruction set that defines the AI's behavior and capabilities.
                    </p>
                    <textarea id="system-prompt-editor" style="width: 100%; min-height: 400px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.9rem;"></textarea>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button onclick="loadSystemPrompt()" style="padding: 0.75rem 1.5rem; background: var(--accent-blue); border: none; border-radius: 6px; color: white; cursor: pointer;">
                            🔄 Reload
                        </button>
                        <button onclick="saveSystemPrompt()" style="padding: 0.75rem 1.5rem; background: var(--accent-green); border: none; border-radius: 6px; color: white; cursor: pointer;">
                            💾 Save Changes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tools Overview Section -->
            <div class="chart-container">
                <h3 class="chart-title">Available Tools</h3>
                <div id="tools-list" style="padding: 1rem;">
                    <div class="loading">Loading tools...</div>
                </div>
            </div>

            <!-- Capabilities Section -->
            <div class="chart-container" style="margin-top: 2rem;">
                <h3 class="chart-title">AI Capabilities</h3>
                <div style="padding: 1rem;">
                    <ul style="color: var(--text-primary); line-height: 1.8;">
                        <li>🔍 <strong>Data Analysis:</strong> Execute Python code with pandas, numpy, and database access</li>
                        <li>📊 <strong>Visualization:</strong> Create dynamic charts (bar, line, pie, scatter, tables)</li>
                        <li>🔗 <strong>API Integration:</strong> Access crypto prices, news, whale tracking, and more</li>
                        <li>🛠️ <strong>Tool Creation:</strong> Dynamically create new tools during conversation</li>
                        <li>🗄️ <strong>Database:</strong> Query 98,000+ KROM calls with complex SQL</li>
                        <li>🤖 <strong>Background Monitoring:</strong> Autonomous pattern detection and alerts</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api';
        let sessionId = Math.random().toString(36).substring(7);
        let charts = {};

        // Chart.js default settings
        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333333';

        // Tab Management
        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.split-view, .chat-container.analysis-panel').forEach(t => t.style.display = 'none');
            document.querySelector(`#${tab}-tab`).style.display = tab === 'chat' ? 'flex' : 'block';
            event.target.classList.add('active');
            
            if (tab === 'analysis') {
                loadAnalysisDashboard();
            } else if (tab === 'calls') {
                loadCallsTable(1);
            } else if (tab === 'admin') {
                loadAdminPanel();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
            if (sidebar.classList.contains('active')) {
                loadQuickStats();
            }
        }

        // Chat functionality
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            sendMessage(message);
        });

        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? '👤' : '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            sessionId = Math.random().toString(36).substring(7);
            chatMessages.innerHTML = '';
            addMessage(
                `👋 Hello! I'm your KROM Analysis AI Assistant. I can help you with:
                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                    <li>Analyzing KROM call data</li>
                    <li>Finding profitable patterns</li>
                    <li>Tracking group performance</li>
                    <li>Real-time crypto prices</li>
                    <li>Market sentiment analysis</li>
                </ul>
                <p style="margin-top: 0.5rem;">Try asking: "Show me the top performing calls this week" or "What's the win rate for each group?"</p>`,
                'ai'
            );
        }

        function copyConversation() {
            const messages = chatMessages.querySelectorAll('.message');
            let conversationText = '';
            
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user');
                const sender = isUser ? 'User' : 'AI';
                const content = msg.querySelector('.message-content').innerText;
                conversationText += `${sender}: ${content}\n\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(conversationText).then(() => {
                showNotification('📋 Conversation copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('❌ Failed to copy conversation');
            });
        }

        // Analysis Dashboard functionality
        async function loadAnalysisDashboard() {
            // Load all visualizations
            await Promise.all([
                loadOverviewStats(),
                loadROIDistribution(),
                loadNetworkDistribution(),
                loadTopGroups(),
                loadDailyPerformance()
            ]);
        }

        async function loadOverviewStats() {
            try {
                const response = await fetch(`${API_URL}/visualization/overview`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('total-calls').textContent = data.total_calls || '0';
                    document.getElementById('win-rate').textContent = `${data.win_rate || 0}%`;
                    document.getElementById('avg-roi').textContent = `${data.avg_roi || 0}x`;
                    document.getElementById('max-roi').textContent = `${data.max_roi || 0}x`;
                    
                    // Color code based on values
                    const avgRoiElement = document.getElementById('avg-roi');
                    avgRoiElement.classList.remove('positive', 'negative');
                    if (data.avg_roi > 1) avgRoiElement.classList.add('positive');
                    else if (data.avg_roi < 1) avgRoiElement.classList.add('negative');
                }
            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        async function loadROIDistribution() {
            try {
                const response = await fetch(`${API_URL}/visualization/roi_distribution`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const ctx = document.getElementById('roi-chart').getContext('2d');
                    
                    if (charts.roi) charts.roi.destroy();
                    
                    charts.roi = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: result.data.map(d => d.range),
                            datasets: [{
                                label: 'Number of Calls',
                                data: result.data.map(d => d.count),
                                backgroundColor: [
                                    '#ff3366',
                                    '#ff6b6b',
                                    '#feca57',
                                    '#48dbfb',
                                    '#00b4d8',
                                    '#9945ff'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: '#333333'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading ROI distribution:', error);
            }
        }

        async function loadNetworkDistribution() {
            try {
                const response = await fetch(`${API_URL}/visualization/network_distribution`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const ctx = document.getElementById('network-chart').getContext('2d');
                    
                    if (charts.network) charts.network.destroy();
                    
                    charts.network = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: result.data.map(d => d.network),
                            datasets: [{
                                data: result.data.map(d => d.count),
                                backgroundColor: [
                                    '#00b4d8',
                                    '#9945ff',
                                    '#00ff88',
                                    '#ff3366',
                                    '#feca57'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading network distribution:', error);
            }
        }

        async function loadTopGroups() {
            try {
                const response = await fetch(`${API_URL}/visualization/top_groups`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const tbody = document.querySelector('#groups-table tbody');
                    tbody.innerHTML = '';
                    
                    result.data.forEach(group => {
                        const row = document.createElement('tr');
                        const winRate = group.calls_count > 0 ? 
                            ((group.wins / group.calls_count) * 100).toFixed(1) : 0;
                        
                        row.innerHTML = `
                            <td>${group.name}</td>
                            <td>${group.calls_count}</td>
                            <td class="${group.avg_roi > 1 ? 'positive' : group.avg_roi < 1 ? 'negative' : ''}">${group.avg_roi}x</td>
                            <td>${group.wins}</td>
                            <td class="${winRate > 50 ? 'positive' : 'negative'}">${winRate}%</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No data available</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading top groups:', error);
            }
        }

        async function loadDailyPerformance() {
            try {
                const response = await fetch(`${API_URL}/visualization/daily_performance`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const ctx = document.getElementById('daily-chart').getContext('2d');
                    
                    if (charts.daily) charts.daily.destroy();
                    
                    // Reverse data to show oldest to newest
                    const data = result.data.reverse();
                    
                    charts.daily = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.date || 'N/A'),
                            datasets: [{
                                label: 'Average ROI',
                                data: data.map(d => d.avg_roi),
                                borderColor: '#00b4d8',
                                backgroundColor: 'rgba(0, 180, 216, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Calls',
                                data: data.map(d => d.calls),
                                borderColor: '#9945ff',
                                backgroundColor: 'rgba(153, 69, 255, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    grid: {
                                        color: '#333333'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Average ROI'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    grid: {
                                        drawOnChartArea: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Calls'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading daily performance:', error);
            }
        }

        async function loadQuickStats() {
            const statsDiv = document.getElementById('quick-stats');
            statsDiv.innerHTML = '<div class="loading">Loading stats...</div>';
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Give me a quick overview of the database stats',
                        session_id: 'stats_' + Math.random().toString(36).substring(7)
                    })
                });
                
                const data = await response.json();
                statsDiv.innerHTML = data.response;
            } catch (error) {
                statsDiv.innerHTML = '<div class="error">Error loading stats</div>';
            }
        }

        // Calls Table functionality
        let currentPage = 1;
        
        async function loadCallsTable(page = 1) {
            currentPage = page;
            const sortSelect = document.getElementById('sort-select');
            const perPageSelect = document.getElementById('perpage-select');
            const [sortBy, sortOrder] = sortSelect.value.split('-');
            const perPage = parseInt(perPageSelect.value);
            
            try {
                const response = await fetch(`${API_URL}/calls?page=${page}&per_page=${perPage}&sort_by=${sortBy}&sort_order=${sortOrder}`);
                const result = await response.json();
                
                if (result.success) {
                    renderCallsTable(result.data);
                    renderPagination(result.pagination);
                }
            } catch (error) {
                console.error('Error loading calls:', error);
                document.querySelector('#calls-table tbody').innerHTML = 
                    '<tr><td colspan="18" style="text-align: center; color: var(--accent-red);">Error loading calls</td></tr>';
            }
        }
        
        function renderCallsTable(calls) {
            const tbody = document.querySelector('#calls-table tbody');
            tbody.innerHTML = '';
            
            if (calls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" style="text-align: center; color: var(--text-secondary);">No calls found</td></tr>';
                return;
            }
            
            calls.forEach(call => {
                const row = document.createElement('tr');
                const roiClass = call.roi > 1 ? 'positive' : call.roi < 1 ? 'negative' : '';
                const statusClass = call.status === 'profit' ? 'positive' : 'negative';
                
                // Helper function to format timestamp
                const formatTimestamp = (timestamp) => {
                    if (!timestamp) return 'N/A';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString();
                };
                
                // Helper function to truncate long strings
                const truncate = (str, length = 20) => {
                    if (!str) return 'N/A';
                    return str.length > length ? str.substring(0, length) + '...' : str;
                };
                
                row.innerHTML = `
                    <td>${call.formatted_date || 'N/A'}</td>
                    <td><strong>${call.ticker}</strong></td>
                    <td>${call.network || 'N/A'}</td>
                    <td>${call.group_name || 'N/A'}</td>
                    <td><span title="${call.contract_address || 'N/A'}">${truncate(call.contract_address)}</span></td>
                    <td><span title="${call.pair_address || 'N/A'}">${truncate(call.pair_address)}</span></td>
                    <td>${formatPrice(call.buy_price)}</td>
                    <td>${formatPrice(call.top_price)}</td>
                    <td>${formatPrice(call.current_price)}</td>
                    <td class="${roiClass}">${call.roi ? call.roi.toFixed(2) : '0.00'}x</td>
                    <td class="${roiClass}">${call.profit_percent ? call.profit_percent.toFixed(1) : '0.0'}%</td>
                    <td>${formatTimestamp(call.buy_timestamp)}</td>
                    <td>${formatTimestamp(call.top_timestamp)}</td>
                    <td>${call.hidden ? '🔒 Yes' : '👁️ No'}</td>
                    <td>${call.trade_error ? '❌ Yes' : '✅ No'}</td>
                    <td>${call.message_id || 'N/A'}</td>
                    <td class="${statusClass}">${call.status || 'unknown'}</td>
                    <td><button onclick="showRawData('${call.id}')" style="background: var(--accent-blue); border: none; padding: 4px 8px; border-radius: 4px; color: white; cursor: pointer;">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderPagination(pagination) {
            // Update info
            const infoDiv = document.getElementById('pagination-info');
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            infoDiv.innerHTML = `Showing ${start}-${end} of ${pagination.total} calls`;
            
            // Update controls
            const controlsDiv = document.getElementById('pagination-controls');
            controlsDiv.innerHTML = '';
            
            // Previous button
            if (pagination.has_prev) {
                const prevBtn = createPaginationButton('← Previous', () => loadCallsTable(pagination.page - 1));
                controlsDiv.appendChild(prevBtn);
            }
            
            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(1, pagination.page - Math.floor(maxButtons / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = createPaginationButton(i.toString(), () => loadCallsTable(i));
                if (i === pagination.page) {
                    btn.style.background = 'var(--accent-blue)';
                    btn.style.color = 'white';
                }
                controlsDiv.appendChild(btn);
            }
            
            // Next button
            if (pagination.has_next) {
                const nextBtn = createPaginationButton('Next →', () => loadCallsTable(pagination.page + 1));
                controlsDiv.appendChild(nextBtn);
            }
        }
        
        function createPaginationButton(text, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.onclick = onClick;
            btn.style.cssText = `
                padding: 0.5rem 1rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
            `;
            btn.onmouseover = () => {
                btn.style.borderColor = 'var(--accent-blue)';
                btn.style.transform = 'translateY(-1px)';
            };
            btn.onmouseout = () => {
                btn.style.borderColor = 'var(--border-color)';
                btn.style.transform = 'translateY(0)';
            };
            return btn;
        }
        
        function formatPrice(price) {
            if (!price || price === 0) return '$0.00';
            if (price < 0.01) return `$${price.toFixed(6)}`;
            if (price < 1) return `$${price.toFixed(4)}`;
            return `$${price.toFixed(2)}`;
        }
        
        async function showRawData(callId) {
            try {
                const response = await fetch(`http://localhost:8000/api/call/${callId}/raw`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create modal to show raw data
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    `;
                    
                    const content = document.createElement('div');
                    content.style.cssText = `
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        padding: 2rem;
                        max-width: 80%;
                        max-height: 80%;
                        overflow: auto;
                        color: var(--text-primary);
                    `;
                    
                    content.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                            <h3>Raw JSON Data for Call: ${callId}</h3>
                            <button onclick="this.closest('.modal').remove()" style="background: var(--accent-red); border: none; padding: 8px 16px; border-radius: 4px; color: white; cursor: pointer; margin-left: auto;">Close</button>
                        </div>
                        <pre style="background: var(--bg-primary); padding: 1rem; border-radius: 4px; overflow: auto; white-space: pre-wrap; font-size: 12px;">${JSON.stringify(data.raw_data, null, 2)}</pre>
                    `;
                    
                    modal.className = 'modal';
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                } else {
                    alert('Failed to load raw data');
                }
            } catch (error) {
                console.error('Error loading raw data:', error);
                alert('Error loading raw data');
            }
        }

        // New AI-powered features
        let isMonitoring = false;
        let monitoringInterval = null;
        let dynamicChartsContainer = null;

        async function suggestAnalysis() {
            const message = "Suggest 5-6 powerful analyses I can run on the KROM data. Consider patterns, correlations, and insights that would be valuable.";
            addMessage(message, 'user');
            sendMessage(message);
        }

        async function surpriseMe() {
            const message = "Pick an interesting analysis and run it. Execute code to analyze the data in a unique way and create a visualization. Surprise me with something insightful!";
            addMessage(message, 'user');
            sendMessage(message);
        }

        function toggleMonitoring() {
            const btn = document.getElementById('monitor-btn');
            isMonitoring = !isMonitoring;
            
            if (isMonitoring) {
                btn.innerHTML = '⏸️ Stop Monitoring';
                btn.style.background = 'linear-gradient(135deg, #666, #999)';
                startBackgroundMonitoring();
            } else {
                btn.innerHTML = '🔍 Start Monitoring';
                btn.style.background = 'linear-gradient(135deg, #ff3366, #ff6b6b)';
                stopBackgroundMonitoring();
            }
        }

        function startBackgroundMonitoring() {
            // Run initial analysis
            runBackgroundAnalysis();
            
            // Set up interval for continuous monitoring (every 30 seconds for demo)
            monitoringInterval = setInterval(runBackgroundAnalysis, 30000);
        }

        function stopBackgroundMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        async function runBackgroundAnalysis() {
            // Send a background analysis request
            const analysisTypes = [
                "Find sudden spikes in call volume for any group",
                "Detect tokens that are currently mooning from our calls",
                "Identify unusual trading patterns in the last hour",
                "Find correlations between call timing and success rate",
                "Discover groups with improving win rates"
            ];
            
            const randomAnalysis = analysisTypes[Math.floor(Math.random() * analysisTypes.length)];
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `[BACKGROUND ANALYSIS] ${randomAnalysis}`,
                        session_id: sessionId + '_monitor'
                    })
                });
                
                const data = await response.json();
                
                if (data.response && data.response.includes('INSIGHT') || data.response.includes('ALERT')) {
                    showNotification(data.response);
                }
            } catch (error) {
                console.error('Background analysis error:', error);
            }
        }

        function showNotification(message) {
            // Create a toast notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
                border: 1px solid var(--accent-blue);
                border-radius: 8px;
                padding: 1rem 1.5rem;
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong style="color: var(--accent-blue);">🔍 AI Discovery</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #666; cursor: pointer; margin-left: 1rem;">✕</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                notification.remove();
            }, 10000);
        }

        // Enhanced sendMessage to handle tool responses
        async function sendMessage(message) {
            userInput.value = '';
            typingIndicator.style.display = 'flex';
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                typingIndicator.style.display = 'none';
                
                if (data.response) {
                    addMessage(data.response, 'ai');
                    
                    // Check if response contains visualization data
                    if (data.visualization) {
                        console.log('Visualization data received:', data.visualization);
                        addDynamicVisualization(data.visualization);
                    } else {
                        console.log('No visualization data in response:', data);
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            } catch (error) {
                typingIndicator.style.display = 'none';
                addMessage('Sorry, I couldn\'t connect to the server. Please make sure it\'s running.', 'ai');
            }
        }

        function addDynamicVisualization(vizData) {
            // Clear placeholder if it exists
            const placeholder = document.getElementById('workspace-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // Get workspace content
            const workspaceContent = document.getElementById('workspace-content');
            
            // Get or create dynamic charts container
            if (!dynamicChartsContainer) {
                dynamicChartsContainer = document.createElement('div');
                dynamicChartsContainer.id = 'dynamic-charts';
                dynamicChartsContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                    gap: 1rem;
                `;
                workspaceContent.appendChild(dynamicChartsContainer);
            }
            
            // Create unique ID for this chart
            const chartId = `dynamic-chart-${Date.now()}`;
            
            // Create new chart container
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3 class="chart-title">${vizData.title || 'Analysis Result'}</h3>
                <div class="chart-wrapper">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
            
            dynamicChartsContainer.appendChild(chartContainer);
            
            // Wait for DOM to update
            setTimeout(() => {
                const ctx = document.getElementById(chartId).getContext('2d');
                
                // Create chart based on visualization type
                if (vizData.type === 'table' && vizData.data) {
                    // For tables, convert to a simple chart
                    createTableVisualization(chartContainer, vizData.data);
                } else if (vizData.data) {
                    // Create chart from data
                    new Chart(ctx, {
                        type: vizData.type || 'bar',
                        data: vizData.chartData || formatDataForChart(vizData.data, vizData.type),
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: vizData.type !== 'bar'
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: vizData.type === 'bar' || vizData.type === 'line' ? {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: '#333333'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            } : {}
                        }
                    });
                }
            }, 100);
        }
        
        function formatDataForChart(data, type) {
            // Handle simple format from AI: {labels: [...], values: [...]}
            if (data.labels && data.values) {
                return {
                    labels: data.labels,
                    datasets: [{
                        label: 'Value',
                        data: data.values,
                        backgroundColor: [
                            '#00b4d8', '#9945ff', '#00ff88', '#ff3366', '#feca57',
                            '#48dbfb', '#ff6b6b', '#54a0ff', '#feca57', '#ff9ff3'
                        ],
                        borderColor: '#00b4d8',
                        borderWidth: 2,
                        fill: false
                    }]
                };
            }
            
            // Handle scatter plot format: {x: [...], y: [...]}
            if (data.x && data.y) {
                return {
                    datasets: [{
                        label: 'Data Points',
                        data: data.x.map((x, i) => ({ x: x, y: data.y[i] })),
                        backgroundColor: '#00b4d8',
                        borderColor: '#00b4d8',
                        borderWidth: 1,
                        pointRadius: 4
                    }]
                };
            }
            
            // Handle pandas DataFrame format
            if (data.columns && data.data) {
                const labels = data.data.map((row, idx) => 
                    data.index ? data.index[idx] : `Item ${idx + 1}`
                );
                
                // For single value columns, use the first numeric column
                const numericColumns = data.columns.filter(col => 
                    typeof data.data[0][col] === 'number'
                );
                
                if (numericColumns.length === 1) {
                    return {
                        labels: labels,
                        datasets: [{
                            label: numericColumns[0],
                            data: data.data.map(row => row[numericColumns[0]]),
                            backgroundColor: [
                                '#00b4d8', '#9945ff', '#00ff88', '#ff3366', '#feca57',
                                '#48dbfb', '#ff6b6b', '#54a0ff', '#feca57', '#ff9ff3'
                            ],
                            borderWidth: 0
                        }]
                    };
                } else if (numericColumns.length > 1) {
                    // Multiple numeric columns - create multi-dataset
                    return {
                        labels: labels,
                        datasets: numericColumns.map((col, idx) => ({
                            label: col,
                            data: data.data.map(row => row[col]),
                            backgroundColor: ['#00b4d8', '#9945ff', '#00ff88', '#ff3366', '#feca57'][idx % 5],
                            borderColor: ['#00b4d8', '#9945ff', '#00ff88', '#ff3366', '#feca57'][idx % 5],
                            borderWidth: 2,
                            fill: false
                        }))
                    };
                }
            }
            
            // Handle simple array data
            if (Array.isArray(data)) {
                return {
                    labels: data.map((_, idx) => `Item ${idx + 1}`),
                    datasets: [{
                        label: 'Value',
                        data: data,
                        backgroundColor: '#00b4d8',
                        borderWidth: 0
                    }]
                };
            }
            
            // Handle object with x,y format
            if (data.x && data.y) {
                return {
                    labels: data.x,
                    datasets: [{
                        label: 'Value',
                        data: data.y,
                        backgroundColor: '#00b4d8',
                        borderWidth: 0
                    }]
                };
            }
            
            return null;
        }
        
        function createTableVisualization(container, data) {
            // Replace canvas with table for table-type visualizations
            const wrapper = container.querySelector('.chart-wrapper');
            wrapper.innerHTML = '';
            
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; color: var(--text-primary);';
            
            if (data.columns && data.data) {
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                data.columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    th.style.cssText = 'padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color);';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                data.data.slice(0, 10).forEach(row => {
                    const tr = document.createElement('tr');
                    data.columns.forEach(col => {
                        const td = document.createElement('td');
                        td.textContent = row[col];
                        td.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid var(--border-color);';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
            }
            
            wrapper.appendChild(table);
        }

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        function clearWorkspace() {
            const workspaceContent = document.getElementById('workspace-content');
            workspaceContent.innerHTML = `
                <div id="workspace-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center;">
                    <div>
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                        <p>Your visualizations will appear here</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Ask the AI to create charts, tables, or run analysis</p>
                    </div>
                </div>
            `;
            dynamicChartsContainer = null;
        }

        // Admin Panel Functions
        async function loadAdminPanel() {
            loadSystemPrompt();
            loadToolsList();
        }

        async function loadSystemPrompt() {
            try {
                const response = await fetch(`${API_URL}/admin/system-prompt`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('system-prompt-editor').value = data.prompt;
                }
            } catch (error) {
                console.error('Error loading system prompt:', error);
                document.getElementById('system-prompt-editor').value = 'Error loading system prompt';
            }
        }

        async function saveSystemPrompt() {
            const prompt = document.getElementById('system-prompt-editor').value;
            try {
                const response = await fetch(`${API_URL}/admin/system-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('✅ System prompt updated successfully!');
                } else {
                    showNotification('❌ Failed to update system prompt');
                }
            } catch (error) {
                console.error('Error saving system prompt:', error);
                showNotification('❌ Error saving system prompt');
            }
        }

        async function loadToolsList() {
            try {
                const response = await fetch(`${API_URL}/tools`);
                const data = await response.json();
                
                const toolsList = document.getElementById('tools-list');
                if (data.tools && data.tools.length > 0) {
                    toolsList.innerHTML = '<ul style="color: var(--text-primary); line-height: 1.8;">';
                    data.tools.forEach(tool => {
                        const params = tool.parameters ? Object.keys(tool.parameters).join(', ') : 'none';
                        toolsList.innerHTML += `
                            <li>
                                <strong style="color: var(--accent-blue);">${tool.name}</strong>
                                <span style="color: var(--text-secondary);">(${params})</span>
                                <br>
                                <span style="font-size: 0.9rem;">${tool.description}</span>
                            </li>
                        `;
                    });
                    toolsList.innerHTML += '</ul>';
                } else {
                    toolsList.innerHTML = '<p style="color: var(--text-secondary);">No tools available</p>';
                }
            } catch (error) {
                console.error('Error loading tools:', error);
                document.getElementById('tools-list').innerHTML = '<p style="color: var(--accent-red);">Error loading tools</p>';
            }
        }
    </script>
</body>
</html>