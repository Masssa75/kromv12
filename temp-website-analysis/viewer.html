<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KROM Website Analysis Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .filters {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 500;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #e9ecef;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-alpha {
            background: #d4edda;
            color: #155724;
        }
        
        .tier-solid {
            background: #cce5ff;
            color: #004085;
        }
        
        .tier-basic {
            background: #fff3cd;
            color: #856404;
        }
        
        .tier-trash {
            background: #f8d7da;
            color: #721c24;
        }
        
        .score {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .score-high { color: #28a745; }
        .score-medium { color: #ffc107; }
        .score-low { color: #dc3545; }
        
        .ticker {
            font-weight: 600;
            color: #495057;
        }
        
        .network {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .utility-yes { color: #28a745; }
        .utility-no { color: #dc3545; }
        
        .flags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .flag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .green-flag {
            background: #d4edda;
            color: #155724;
        }
        
        .red-flag {
            background: #f8d7da;
            color: #721c24;
        }
        
        .expandable {
            cursor: pointer;
        }
        
        .expandable:hover {
            background: #f0f0f0;
        }
        
        .details {
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-top: 10px;
            display: none;
        }
        
        .details.show {
            display: block;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-weight: 500;
            color: #212529;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .refresh-info {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç KROM Website Analysis</h1>
            <div class="stats" id="stats">
                <div class="stat">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">Total Analyzed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="alpha-count">0</div>
                    <div class="stat-label">ALPHA</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="solid-count">0</div>
                    <div class="stat-label">SOLID</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="basic-count">0</div>
                    <div class="stat-label">BASIC</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="trash-count">0</div>
                    <div class="stat-label">TRASH</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="avg-score">0</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Tier Filter</label>
                <select id="tier-filter">
                    <option value="">All Tiers</option>
                    <option value="ALPHA">ALPHA</option>
                    <option value="SOLID">SOLID</option>
                    <option value="BASIC">BASIC</option>
                    <option value="TRASH">TRASH</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Network</label>
                <select id="network-filter">
                    <option value="">All Networks</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Min Score</label>
                <input type="number" id="min-score" min="1" max="10" placeholder="1">
            </div>
            
            <div class="filter-group">
                <label>Has Utility</label>
                <select id="utility-filter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="search" placeholder="Search ticker...">
            </div>
            
            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
            <button onclick="exportCSV()">Export CSV</button>
            <button onclick="refreshData()">Refresh</button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">Loading data...</div>
            <div id="no-data" class="no-data" style="display: none;">No data found</div>
            <table id="results-table" style="display: none;">
                <thead>
                    <tr>
                        <th onclick="sortTable('ticker')">Ticker ‚Üï</th>
                        <th onclick="sortTable('network')">Network ‚Üï</th>
                        <th onclick="sortTable('score')">Score ‚Üï</th>
                        <th onclick="sortTable('tier')">Tier ‚Üï</th>
                        <th onclick="sortTable('category')">Category ‚Üï</th>
                        <th onclick="sortTable('utility')">Has Utility ‚Üï</th>
                        <th>Key Findings</th>
                        <th onclick="sortTable('analyzed')">Analyzed ‚Üï</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                </tbody>
            </table>
        </div>
        
        <div class="refresh-info">
            Auto-refresh every 30 seconds | Last updated: <span id="last-updated">Never</span>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        let currentSort = { column: 'score', direction: 'desc' };
        
        async function fetchData() {
            try {
                const response = await fetch('http://localhost:5000/api/analysis');
                const data = await response.json();
                allData = data.results;
                filteredData = [...allData];
                
                updateStats(data.stats);
                updateNetworkFilter();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-table').style.display = 'table';
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading').innerHTML = 'Error loading data. Make sure the Flask server is running.';
            }
        }
        
        function updateStats(stats) {
            document.getElementById('total-count').textContent = stats.total || 0;
            document.getElementById('alpha-count').textContent = stats.alpha || 0;
            document.getElementById('solid-count').textContent = stats.solid || 0;
            document.getElementById('basic-count').textContent = stats.basic || 0;
            document.getElementById('trash-count').textContent = stats.trash || 0;
            document.getElementById('avg-score').textContent = (stats.avg_score || 0).toFixed(1);
        }
        
        function updateNetworkFilter() {
            const networks = [...new Set(allData.map(d => d.network))].filter(Boolean).sort();
            const select = document.getElementById('network-filter');
            select.innerHTML = '<option value="">All Networks</option>';
            networks.forEach(network => {
                select.innerHTML += `<option value="${network}">${network}</option>`;
            });
        }
        
        function renderTable() {
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                document.getElementById('no-data').style.display = 'block';
                document.getElementById('results-table').style.display = 'none';
                return;
            }
            
            document.getElementById('no-data').style.display = 'none';
            document.getElementById('results-table').style.display = 'table';
            
            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'expandable';
                row.onclick = () => toggleDetails(index);
                
                const scoreClass = item.website_score >= 7 ? 'score-high' : 
                                  item.website_score >= 4 ? 'score-medium' : 'score-low';
                
                const tierClass = `tier-${(item.website_tier || 'basic').toLowerCase()}`;
                
                const utilityIcon = item.has_real_utility ? '‚úÖ' : '‚ùå';
                const utilityClass = item.has_real_utility ? 'utility-yes' : 'utility-no';
                
                row.innerHTML = `
                    <td><span class="ticker">${item.ticker || ''}</span></td>
                    <td><span class="network">${item.network || ''}</span></td>
                    <td><span class="score ${scoreClass}">${item.website_score || 0}/10</span></td>
                    <td><span class="tier-badge ${tierClass}">${item.website_tier || 'N/A'}</span></td>
                    <td>${item.project_category || 'Unknown'}</td>
                    <td><span class="${utilityClass}">${utilityIcon}</span></td>
                    <td>${(item.key_findings || '').substring(0, 60)}${item.key_findings && item.key_findings.length > 60 ? '...' : ''}</td>
                    <td>${item.analyzed_at ? new Date(item.analyzed_at).toLocaleDateString() : 'N/A'}</td>
                `;
                
                tbody.appendChild(row);
                
                // Add details row
                const detailsRow = document.createElement('tr');
                detailsRow.innerHTML = `
                    <td colspan="8">
                        <div class="details" id="details-${index}">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Website URL</span>
                                    <span class="detail-value"><a href="${item.website_url}" target="_blank">${item.website_url || 'N/A'}</a></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Contract Address</span>
                                    <span class="detail-value" style="font-size: 0.8em; word-break: break-all;">${item.contract_address || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Documentation Quality</span>
                                    <span class="detail-value">${item.documentation_quality || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Team Transparency</span>
                                    <span class="detail-value">${item.team_transparency || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Has Audit</span>
                                    <span class="detail-value">${item.has_audit ? '‚úÖ Yes' : '‚ùå No'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Has Whitepaper</span>
                                    <span class="detail-value">${item.has_whitepaper ? '‚úÖ Yes' : '‚ùå No'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Has Roadmap</span>
                                    <span class="detail-value">${item.has_roadmap ? '‚úÖ Yes' : '‚ùå No'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Working Product</span>
                                    <span class="detail-value">${item.has_working_product ? '‚úÖ Yes' : '‚ùå No'}</span>
                                </div>
                            </div>
                            
                            ${item.utility_description ? `
                            <div style="margin-bottom: 15px;">
                                <div class="detail-label">Utility Description</div>
                                <div class="detail-value">${item.utility_description}</div>
                            </div>
                            ` : ''}
                            
                            ${item.green_flags && item.green_flags.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div class="detail-label">Green Flags</div>
                                <div class="flags">
                                    ${item.green_flags.map(flag => `<span class="flag green-flag">${flag}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${item.red_flags && item.red_flags.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div class="detail-label">Red Flags</div>
                                <div class="flags">
                                    ${item.red_flags.map(flag => `<span class="flag red-flag">${flag}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div>
                                <div class="detail-label">Key Findings</div>
                                <div class="detail-value">${item.key_findings || 'No findings available'}</div>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(detailsRow);
            });
        }
        
        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            details.classList.toggle('show');
        }
        
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'ticker':
                        aVal = a.ticker || '';
                        bVal = b.ticker || '';
                        break;
                    case 'network':
                        aVal = a.network || '';
                        bVal = b.network || '';
                        break;
                    case 'score':
                        aVal = a.website_score || 0;
                        bVal = b.website_score || 0;
                        break;
                    case 'tier':
                        const tierOrder = { 'ALPHA': 4, 'SOLID': 3, 'BASIC': 2, 'TRASH': 1 };
                        aVal = tierOrder[a.website_tier] || 0;
                        bVal = tierOrder[b.website_tier] || 0;
                        break;
                    case 'category':
                        aVal = a.project_category || '';
                        bVal = b.project_category || '';
                        break;
                    case 'utility':
                        aVal = a.has_real_utility ? 1 : 0;
                        bVal = b.has_real_utility ? 1 : 0;
                        break;
                    case 'analyzed':
                        aVal = new Date(a.analyzed_at || 0).getTime();
                        bVal = new Date(b.analyzed_at || 0).getTime();
                        break;
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            renderTable();
        }
        
        function applyFilters() {
            filteredData = allData.filter(item => {
                const tierFilter = document.getElementById('tier-filter').value;
                const networkFilter = document.getElementById('network-filter').value;
                const minScore = document.getElementById('min-score').value;
                const utilityFilter = document.getElementById('utility-filter').value;
                const search = document.getElementById('search').value.toLowerCase();
                
                if (tierFilter && item.website_tier !== tierFilter) return false;
                if (networkFilter && item.network !== networkFilter) return false;
                if (minScore && (item.website_score || 0) < parseInt(minScore)) return false;
                if (utilityFilter && String(item.has_real_utility) !== utilityFilter) return false;
                if (search && !item.ticker.toLowerCase().includes(search)) return false;
                
                return true;
            });
            
            renderTable();
        }
        
        function resetFilters() {
            document.getElementById('tier-filter').value = '';
            document.getElementById('network-filter').value = '';
            document.getElementById('min-score').value = '';
            document.getElementById('utility-filter').value = '';
            document.getElementById('search').value = '';
            
            filteredData = [...allData];
            renderTable();
        }
        
        function exportCSV() {
            let csv = 'Ticker,Network,Score,Tier,Category,Has Utility,Website URL,Key Findings\n';
            
            filteredData.forEach(item => {
                csv += `"${item.ticker || ''}","${item.network || ''}",${item.website_score || 0},"${item.website_tier || ''}","${item.project_category || ''}",${item.has_real_utility || false},"${item.website_url || ''}","${(item.key_findings || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `website_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-table').style.display = 'none';
            fetchData();
        }
        
        // Initial load
        fetchData();
        
        // Auto-refresh every 30 seconds
        setInterval(fetchData, 30000);
    </script>
</body>
</html>